# Security Migration Guide

This guide helps you migrate to the new security-enhanced configuration with no hardcoded credentials.

## What Changed?

As of this security update:

1. ❌ **Removed**: Hardcoded passwords from `docker-compose.yml`
2. ✅ **Added**: Environment variable requirements for sensitive credentials
3. ✅ **Added**: Pre-commit hooks to prevent secret commits
4. ✅ **Added**: Comprehensive secret detection tools and documentation

## Migration Steps

### For Existing Developers

If you already have a local checkout:

#### Quick Migration (Recommended)

```bash
# 1. Pull the latest changes
git pull origin main

# 2. Run the bootstrap script (it will generate secure credentials)
./scripts/bootstrap_local_dev.sh

# 3. Install pre-commit hooks (choose one)
# Option A: Pre-commit framework
pip install pre-commit
pre-commit install

# Option B: Husky (auto-installed with pnpm)
pnpm install

# 4. Restart your docker services
docker-compose down
docker-compose up -d
```

#### Manual Migration

If you prefer to migrate manually:

```bash
# 1. Pull the latest changes
git pull origin main

# 2. Create .env.local from template
cp .env.example .env.local

# 3. Generate secure passwords
POSTGRES_PASSWORD=$(openssl rand -base64 32 | tr -d '\n')
MINIO_ROOT_PASSWORD=$(openssl rand -base64 32 | tr -d '\n')
SESSION_SECRET=$(openssl rand -base64 32 | tr -d '\n')
IRON_SESSION_PASSWORD=$(openssl rand -base64 32 | tr -d '\n')

# 4. Update .env.local with the generated values
# Edit .env.local and replace CHANGE_ME_* placeholders with the generated secrets above

# 5. Install dependencies
pnpm install

# 6. Install pre-commit hooks
pip install pre-commit
pre-commit install

# 7. Restart docker services
docker-compose down
docker-compose up -d
```

### For New Developers

New developers joining the project should follow the standard setup:

```bash
# 1. Clone the repository
git clone https://github.com/Kamil1230xd/aura-sign-mvp.git
cd aura-sign-mvp

# 2. Run bootstrap (handles everything)
./scripts/bootstrap_local_dev.sh

# 3. Install pre-commit hooks
pip install pre-commit
pre-commit install
```

## Required Environment Variables

The following environment variables are now **required** for docker-compose:

### PostgreSQL
- `POSTGRES_PASSWORD` - Database password (generated by bootstrap script)
- `POSTGRES_USER` - Database user (defaults to `aura_user`)
- `POSTGRES_DB` - Database name (defaults to `aura`)

### MinIO
- `MINIO_ROOT_PASSWORD` - MinIO root password (generated by bootstrap script)
- `MINIO_ROOT_USER` - MinIO root user (defaults to `minio`)

### Application
- `SESSION_SECRET` - Session encryption secret (generated by bootstrap script)
- `IRON_SESSION_PASSWORD` - Iron session password (generated by bootstrap script)

## Troubleshooting

### Error: "POSTGRES_PASSWORD must be set as environment variable"

**Problem**: Docker-compose can't find required environment variables.

**Solution**: 
```bash
# Ensure .env.local exists and is sourced
source .env.local
docker-compose up -d
```

Or use the bootstrap script:
```bash
./scripts/bootstrap_local_dev.sh
```

### Pre-commit hooks not running

**Problem**: Commits aren't being checked for secrets.

**Solution**:
```bash
# Reinstall hooks
pre-commit uninstall
pre-commit install

# Test manually
pre-commit run --all-files
```

### Can't find old credentials

**Problem**: You need the old default passwords for data recovery.

**Old defaults** (⚠️ DO NOT USE IN NEW SETUPS):
- PostgreSQL: `aura_user` / `aura_pass`
- MinIO: `minio` / `minio123`

**Action**: If you have data with old credentials:
```bash
# Export data with old credentials
export POSTGRES_PASSWORD=aura_pass
export MINIO_ROOT_PASSWORD=minio123

# Start services
docker-compose up -d

# Backup data
pg_dump -h localhost -U aura_user aura > backup.sql

# Update to new credentials
./scripts/bootstrap_local_dev.sh

# Restore data
psql -h localhost -U aura_user aura < backup.sql
```

### Gitleaks not installed

**Problem**: Pre-commit hook warns about gitleaks not being installed.

**Solution**:
```bash
# macOS
brew install gitleaks

# Linux (download binary)
wget https://github.com/gitleaks/gitleaks/releases/download/v8.18.1/gitleaks_8.18.1_linux_x64.tar.gz
tar -xzf gitleaks_8.18.1_linux_x64.tar.gz
sudo mv gitleaks /usr/local/bin/

# Verify installation
gitleaks version

# Or use Docker alternative
pnpm run check-secrets
```

## FAQ

### Q: Why can't I use the old default passwords?

**A**: Hardcoded credentials are a security risk. Even for local development, using secure random passwords:
- Prevents accidental production use of dev credentials
- Trains good security practices
- Reduces risk if local environment is compromised
- Complies with security best practices

### Q: Can I use my own passwords instead of generated ones?

**A**: Yes, but they must be:
- At least 32 characters long
- Cryptographically random (use `openssl rand -base64 32`)
- Stored in `.env.local` (never committed)
- Different for each service

### Q: What if I accidentally commit a secret?

**A**: Follow the incident response procedure:

1. **STOP** - Don't push if you haven't already
2. **Rotate** - Change the secret immediately
3. **Remove from history** - See [SECRET_DETECTION.md](SECRET_DETECTION.md)
4. **Notify** - Inform team leads

### Q: Do pre-commit hooks work with all git clients?

**A**: Yes, pre-commit hooks work with:
- Command-line git
- Most Git GUIs (GitKraken, SourceTree, etc.)
- VS Code Git integration
- JetBrains IDEs

Some GUIs may require enabling hook execution in settings.

### Q: Will this affect CI/CD?

**A**: No changes needed for CI/CD:
- CI already uses GitHub secrets for credentials
- Gitleaks secret scanning already configured
- New .gitleaks.toml improves accuracy (fewer false positives)

### Q: How do I verify my setup is secure?

**A**: Run these checks:

```bash
# 1. Verify .env.local is gitignored
git check-ignore .env.local
# Should output: .env.local

# 2. Check no secrets in tracked files
pnpm run check-secrets

# 3. Test pre-commit hooks
echo "SECRET_KEY=real_secret_value" > test.txt
git add test.txt
git commit -m "test"
# Should be blocked by gitleaks

# Clean up
git reset HEAD test.txt
rm test.txt

# 4. Verify docker-compose requires env vars
unset POSTGRES_PASSWORD
docker-compose config
# Should error about missing POSTGRES_PASSWORD
```

## Additional Resources

- [SECRET_DETECTION.md](SECRET_DETECTION.md) - Comprehensive secret detection guide
- [README.md](../../README.md#security-notes-must-read) - Security best practices
- [CONTRIBUTING.md](../../CONTRIBUTING.md#security-guidelines) - Security contribution guidelines
- [.gitleaks.toml](../../.gitleaks.toml) - Gitleaks configuration

## Support

If you encounter issues during migration:

1. Check this guide's troubleshooting section
2. Review [SECRET_DETECTION.md](SECRET_DETECTION.md)
3. Check existing issues on GitHub
4. Contact team leads or open a new issue

## Version History

- **v1.0** (2024-12) - Initial security hardening
  - Removed hardcoded credentials
  - Added pre-commit hooks
  - Added secret detection tools
  - Created comprehensive documentation
