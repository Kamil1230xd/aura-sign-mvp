name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  packages: read

jobs:
  # Job 1: common configuration + fast validation (lint/typecheck/unit)
  configure:
    name: Configure & Validate
    runs-on: ubuntu-latest
    outputs:
      configure-id: ${{ steps.set-id.outputs.id }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node + pnpm (composite)
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
          pnpm-version: '8'
          install-deps: 'true'
          frozen: 'true'

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm type-check

      - name: Unit tests
        run: pnpm test:unit

      - name: set-id
        id: set-id
        run: echo "id=configured" >> $GITHUB_OUTPUT

  # Job 2: E2E tests (runs after configure). Conditional execution for PRs from forks is handled.
  e2e:
    name: E2E Tests (docker-compose)
    runs-on: ubuntu-latest
    needs: configure
    if: >
      github.event_name != 'pull_request' ||
      (github.event.pull_request.head.repo.full_name == github.repository)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node + pnpm (composite) - no re-install to save time
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
          pnpm-version: '8'
          install-deps: 'true'
          frozen: 'true'

      - name: Bring up infra (docker compose)
        id: compose
        if: hashFiles('docker-compose.yml') != ''
        run: |
          set -euo pipefail
          # Use Docker Compose plugin; fallback to docker-compose if plugin missing
          if command -v docker compose >/dev/null 2>&1; then
            DC="docker compose"
          else
            DC="docker-compose"
          fi

          echo "Starting infra via $DC"
          $DC up -d || { echo "docker compose up failed"; $DC ps || true; $DC logs || true; exit 1; }

          # Wait for services to be ready (timeout 2m)
          echo "Waiting for services to be ready (timeout 2m)..."
          DEADLINE=$((SECONDS + 120))
          while [ $SECONDS -lt $DEADLINE ]; do
            # Check if any containers are still starting
            if ! $DC ps --format '{{.State}}' | grep -q "starting"; then
              echo "All services ready"
              break
            fi
            echo "Services still starting..."
            sleep 2
          done || true

          echo "Services started. Listing:"
          $DC ps

      - name: Run E2E tests
        env:
          API_BASE_URL: http://localhost:3000
        run: pnpm --filter web test:e2e

      - name: Tear down infra
        if: always() && hashFiles('docker-compose.yml') != ''
        run: |
          if command -v docker compose >/dev/null 2>&1; then
            docker compose down --volumes --remove-orphans || true
          else
            docker-compose down --volumes --remove-orphans || true
          fi

  # Job 3: Security & audit (runs in parallel with e2e)
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    needs: configure
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node + pnpm (composite) - fast (no install)
        uses: ./.github/actions/setup-node-pnpm
        with:
          node-version: '20'
          pnpm-version: '8'
          install-deps: 'true'
          frozen: 'true'

      - name: pnpm audit (low/medium)
        run: |
          set -e
          pnpm audit --level=moderate || true

      - name: gitleaks scan
        uses: zricethezav/gitleaks-action@v2.3.9
        with:
          args: --redact

      - name: CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
